name: Code Quality

on:
    push:
        branches: ["**"]
    pull_request:
        branches: ["**"]

jobs:
    pre-commit:
        name: Pre-commit hooks
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.x"
            - name: Install pre-commit
              run: |
                  python -m pip install --upgrade pip
                  pip install pre-commit
            - name: Run pre-commit
              run: pre-commit run --all-files

    python-lint:
        name: Python linters
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.x"
            - name: Install linters
              run: |
                  python -m pip install --upgrade pip
                  pip install ruff black
            - name: Ruff check
              run: ruff check . || true
            - name: Black check
              run: black --check . || true

    node-lint:
        name: JavaScript/TypeScript linters
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up Node
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"
            - name: Install dependencies
              run: |
                  if [ -f package-lock.json ]; then npm ci; else npm install; fi
            - name: Run ESLint
              run: |
                  if npm run | grep -q "lint"; then npm run lint || true; else npx eslint . --ext .js,.ts || true; fi

    rust-lint:
        name: Rust formatting and clippy
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Install Rust toolchain
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  components: rustfmt, clippy
                  override: true
            - name: Cargo fmt check
              run: cargo fmt --all -- --check || true
            - name: Cargo clippy
              run: cargo clippy --all-targets --all-features -- -D warnings || true
            - name: Cargo audit
              uses: aquaproj/aqua-action@v1
              if: false
              # Note: cargo-audit can be added here if desired; disabled by default to avoid surprises

    update-submodules:
        name: Ensure submodule refs are updated
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive
            - name: Show submodule status
              run: git submodule status --recursive
            - name: Verify repository cleanliness
              run: git status --porcelain
