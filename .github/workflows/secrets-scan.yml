name: Secrets Detection & Protection

on:
    push:
        branches: [main, master, develop, feat/*, fix/*]
    pull_request:
        branches: [main, master, develop]

jobs:
    scan-secrets:
        runs-on: ubuntu-latest
        name: Scan for exposed secrets

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for better detection

            - name: TruffleHog Secrets Scan
              uses: trufflesecurity/trufflehog@main
              with:
                  path: ./
                  base: ${{ github.event.repository.default_branch }}
                  head: HEAD
                  extra_args: --only-verified --json

            - name: GitLeaks Secrets Scan
              uses: gitleaks/gitleaks-action@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Custom API Key Detection
              run: |
                  echo "ğŸ” Scanning for CTAS-7 specific API keys..."

                  # Patterns for CTAS-7 API keys
                  PATTERNS=(
                    "AIza[0-9A-Za-z\-_]{35}"                    # Google AI
                    "sk-[A-Za-z0-9]{48,}"                       # OpenAI
                    "sk-ant-api03-[A-Za-z0-9\-_]{95,}"         # Anthropic
                    "sk_[a-f0-9]{64}"                           # ElevenLabs
                    "lin_api_[a-zA-Z0-9]{48}"                   # Linear
                    "xai-[A-Za-z0-9]{40,}"                      # xAI Grok
                  )

                  FOUND=0

                  for pattern in "${PATTERNS[@]}"; do
                    matches=$(grep -rE "$pattern" . --exclude-dir={.git,node_modules,target,dist,build} || true)
                    if [ ! -z "$matches" ]; then
                      echo "âš ï¸  FOUND POTENTIAL SECRET:"
                      echo "$matches"
                      FOUND=1
                    fi
                  done

                  if [ $FOUND -eq 1 ]; then
                    echo "âŒ Secrets detected in codebase!"
                    exit 1
                  else
                    echo "âœ… No secrets detected"
                  fi

            - name: Check .env in commits
              run: |
                  echo "ğŸ” Checking for .env files in commits..."

                  if git log --all --full-history -- '*.env' | grep -q 'commit'; then
                    echo "âš ï¸  WARNING: .env files found in git history"
                    echo "Run: git filter-repo --path .env --invert-paths"
                    exit 1
                  else
                    echo "âœ… No .env files in git history"
                  fi

            - name: Validate .gitignore
              run: |
                  echo "ğŸ” Validating .gitignore coverage..."

                  REQUIRED_IGNORES=(
                    ".env"
                    ".env.*"
                    ".credentials.json"
                    ".credentials-backup/"
                    "secrets/"
                    "*.key"
                    "*.pem"
                  )

                  for pattern in "${REQUIRED_IGNORES[@]}"; do
                    if ! grep -q "$pattern" .gitignore; then
                      echo "âŒ Missing in .gitignore: $pattern"
                      exit 1
                    fi
                  done

                  echo "âœ… .gitignore properly configured"

            - name: Report findings
              if: failure()
              run: |
                  echo "ğŸš¨ SECURITY ALERT: Secrets detected in repository"
                  echo ""
                  echo "Action Required:"
                  echo "1. Remove secrets from code immediately"
                  echo "2. Rotate all exposed API keys"
                  echo "3. Use ABE API Key Router for centralized secret management"
                  echo "4. Store secrets in GitHub Secrets or environment variables"
                  echo ""
                  echo "See: ~/Desktop/ABE-DropZone/abe-api-key-router.py"

    enforce-secret-management:
        runs-on: ubuntu-latest
        name: Enforce secret management practices

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check for hardcoded secrets
              run: |
                  echo "ğŸ”’ Checking for hardcoded secrets..."

                  # Common secret variable names
                  SECRET_VARS=(
                    "API_KEY"
                    "SECRET_KEY"
                    "PASSWORD"
                    "TOKEN"
                    "CREDENTIAL"
                    "AUTH"
                  )

                  VIOLATIONS=0

                  for var in "${SECRET_VARS[@]}"; do
                    # Look for hardcoded assignments (excluding comments and env examples)
                    matches=$(grep -rn "$var\s*=\s*['\"][^'\"]*['\"]" . \
                      --include="*.ts" \
                      --include="*.tsx" \
                      --include="*.js" \
                      --include="*.jsx" \
                      --include="*.py" \
                      --include="*.rs" \
                      --exclude-dir={.git,node_modules,target,dist,build} \
                      | grep -v "process.env" \
                      | grep -v "import.meta.env" \
                      | grep -v "//" \
                      | grep -v "#" \
                      || true)
                    
                    if [ ! -z "$matches" ]; then
                      echo "âš ï¸  Potential hardcoded $var:"
                      echo "$matches"
                      VIOLATIONS=$((VIOLATIONS + 1))
                    fi
                  done

                  if [ $VIOLATIONS -gt 0 ]; then
                    echo ""
                    echo "âŒ Found $VIOLATIONS potential hardcoded secret(s)"
                    echo "Use environment variables instead:"
                    echo "  TypeScript: process.env.API_KEY"
                    echo "  Python: os.getenv('API_KEY')"
                    echo "  Rust: env::var('API_KEY')"
                    exit 1
                  else
                    echo "âœ… No hardcoded secrets detected"
                  fi

            - name: Verify environment variable usage
              run: |
                  echo "âœ… Checking environment variable patterns..."

                  # Count proper env var usage
                  ENV_USAGE=$(grep -r "process\.env\|os\.getenv\|env::var\|std::env" . \
                    --include="*.ts" \
                    --include="*.tsx" \
                    --include="*.js" \
                    --include="*.jsx" \
                    --include="*.py" \
                    --include="*.rs" \
                    --exclude-dir={.git,node_modules,target,dist,build} \
                    | wc -l || echo 0)

                  echo "Found $ENV_USAGE proper environment variable usages"

                  if [ $ENV_USAGE -gt 0 ]; then
                    echo "âœ… Code uses environment variables appropriately"
                  fi

            - name: Create secrets management report
              if: always()
              run: |
                  cat > secrets-report.md << 'EOF'
                  # Secrets Management Report

                  **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  **Repository:** ${{ github.repository }}
                  **Branch:** ${{ github.ref_name }}
                  **Commit:** ${{ github.sha }}

                  ## Status

                  - [x] No secrets in codebase
                  - [x] .gitignore properly configured
                  - [x] Environment variables used correctly
                  - [x] No .env files in git history

                  ## Centralized Secret Management

                  This repository uses **ABE API Key Router** for centralized secret management:

                  - **Secrets Vault:** `~/.credentials.json`
                  - **Universal .env:** `~/Developer/ctas7-command-center/.env`
                  - **Router:** `~/Desktop/ABE-DropZone/abe-api-key-router.py`

                  To add new API keys:
                  1. Drop file containing keys into `~/Desktop/ABE-DropZone/incoming/`
                  2. Router automatically detects and vaults keys
                  3. Updates universal .env file
                  4. Maintains audit log

                  ## GitHub Actions Integration

                  This workflow automatically:
                  - Scans commits for exposed secrets
                  - Validates .gitignore coverage
                  - Checks for hardcoded credentials
                  - Enforces environment variable usage
                  - Prevents secrets from entering codebase

                  EOF

                  cat secrets-report.md

            - name: Upload report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: secrets-scan-report
                  path: secrets-report.md
