"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("crypto"));function r(e,t,r,n){return new(r||(r=Promise))(function(o,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function s(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,s)}u((n=n.apply(e,t||[])).next())})}function n(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function o(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=n(e),t={},o("next"),o("throw"),o("return"),t[Symbol.asyncIterator]=function(){return this},t);function o(r){t[r]=e[r]&&function(t){return new Promise(function(n,o){(function(e,t,r,n){Promise.resolve(n).then(function(t){e({value:t,done:r})},t)})(n,o,(t=e[r](t)).done,t.value)})}}}"function"==typeof SuppressedError&&SuppressedError;const i="linear-signature";exports.LINEAR_WEBHOOK_SIGNATURE_HEADER=i,exports.LINEAR_WEBHOOK_TS_FIELD="webhookTimestamp",exports.LinearWebhookClient=class{constructor(e){this.secret=e}createHandler(){const e=new Map,t=(t,n)=>r(this,void 0,void 0,function*(){const r=this.getHttpAdapter(t,n);try{if("POST"!==r.method)return r.send(405,"Method not allowed");const t=r.signature;if(!t)return r.send(400,"Missing webhook signature");const n=yield r.readRawBody();let o;try{o=this.parseVerifiedPayload(n,t)}catch(e){return r.send(400,"Invalid webhook")}const i=this.collectHandlers(e,o.type);return yield Promise.all(i.map(e=>e(o))),r.send(200,"OK")}catch(e){return r.send(500,"Internal server error")}});return t.on=function(t,r){const n=e.get(t)||[];n.push(r),e.set(t,n)},t.off=function(t,r){const n=e.get(t);if(n){const o=n.indexOf(r);o>-1&&(n.splice(o,1),0===n.length&&e.delete(t))}},t.removeAllListeners=function(t){t?e.delete(t):e.clear()},t}isFetchRequest(e){return"object"==typeof e&&null!==e&&"arrayBuffer"in e&&"function"==typeof Reflect.get(e,"arrayBuffer")}createFetchAdapter(e){return{method:e.method,signature:e.headers.get(i),readRawBody:()=>r(this,void 0,void 0,function*(){return Buffer.from(yield e.arrayBuffer())}),send:(e,t)=>new Response(t,{status:e})}}createNodeAdapter(e,t){var n;const a=e.headers[i],s=Array.isArray(a)?null!==(n=a[0])&&void 0!==n?n:null:null!=a?a:null;return{method:e.method||"",signature:s,readRawBody:()=>r(this,void 0,void 0,function*(){var t,r;const n=[];try{for(var i,a=o(e);!(i=yield a.next()).done;){const e=i.value;n.push(Buffer.from(e))}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=a.return)&&(yield r.call(a))}finally{if(t)throw t.error}}return Buffer.concat(n)}),send:(e,r)=>{t.statusCode=e,t.end(r)}}}getHttpAdapter(e,t){return this.isFetchRequest(e)?this.createFetchAdapter(e):this.createNodeAdapter(e,t)}parseVerifiedPayload(e,t){const r=JSON.parse(e.toString());return this.parseData(e,t,r.webhookTimestamp)}collectHandlers(e,t){return[...e.get(t)||[],...e.get("*")||[]]}verify(e,r,n){const o=Buffer.from(t.default.createHmac("sha256",this.secret).update(e).digest("hex")),i=Buffer.from(r);if(o.length!==i.length)throw new Error("Invalid webhook signature");if(!t.default.timingSafeEqual(o,i))throw new Error("Invalid webhook signature");if(n){if(Math.abs((new Date).getTime()-n)>6e4)throw new Error("Invalid webhook timestamp")}return!0}parseData(e,t,r){if(!this.verify(e,t,r))throw new Error("Invalid webhook signature");return JSON.parse(e.toString())}};
//# sourceMappingURL=index-cjs.min.js.map
