import e from"crypto";function t(e,t,r,n){return new(r||(r=Promise))(function(o,i){function a(e){try{u(n.next(e))}catch(e){i(e)}}function s(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(a,s)}u((n=n.apply(e,t||[])).next())})}function r(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=r(e),t={},o("next"),o("throw"),o("return"),t[Symbol.asyncIterator]=function(){return this},t);function o(r){t[r]=e[r]&&function(t){return new Promise(function(n,o){(function(e,t,r,n){Promise.resolve(n).then(function(t){e({value:t,done:r})},t)})(n,o,(t=e[r](t)).done,t.value)})}}}"function"==typeof SuppressedError&&SuppressedError;const o="linear-signature",i="webhookTimestamp";class a{constructor(e){this.secret=e}createHandler(){const e=new Map,r=(r,n)=>t(this,void 0,void 0,function*(){const t=this.getHttpAdapter(r,n);try{if("POST"!==t.method)return t.send(405,"Method not allowed");const r=t.signature;if(!r)return t.send(400,"Missing webhook signature");const n=yield t.readRawBody();let o;try{o=this.parseVerifiedPayload(n,r)}catch(e){return t.send(400,"Invalid webhook")}const i=this.collectHandlers(e,o.type);return yield Promise.all(i.map(e=>e(o))),t.send(200,"OK")}catch(e){return t.send(500,"Internal server error")}});return r.on=function(t,r){const n=e.get(t)||[];n.push(r),e.set(t,n)},r.off=function(t,r){const n=e.get(t);if(n){const o=n.indexOf(r);o>-1&&(n.splice(o,1),0===n.length&&e.delete(t))}},r.removeAllListeners=function(t){t?e.delete(t):e.clear()},r}isFetchRequest(e){return"object"==typeof e&&null!==e&&"arrayBuffer"in e&&"function"==typeof Reflect.get(e,"arrayBuffer")}createFetchAdapter(e){return{method:e.method,signature:e.headers.get(o),readRawBody:()=>t(this,void 0,void 0,function*(){return Buffer.from(yield e.arrayBuffer())}),send:(e,t)=>new Response(t,{status:e})}}createNodeAdapter(e,r){var i;const a=e.headers[o],s=Array.isArray(a)?null!==(i=a[0])&&void 0!==i?i:null:null!=a?a:null;return{method:e.method||"",signature:s,readRawBody:()=>t(this,void 0,void 0,function*(){var t,r;const o=[];try{for(var i,a=n(e);!(i=yield a.next()).done;){const e=i.value;o.push(Buffer.from(e))}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=a.return)&&(yield r.call(a))}finally{if(t)throw t.error}}return Buffer.concat(o)}),send:(e,t)=>{r.statusCode=e,r.end(t)}}}getHttpAdapter(e,t){return this.isFetchRequest(e)?this.createFetchAdapter(e):this.createNodeAdapter(e,t)}parseVerifiedPayload(e,t){const r=JSON.parse(e.toString());return this.parseData(e,t,r.webhookTimestamp)}collectHandlers(e,t){return[...e.get(t)||[],...e.get("*")||[]]}verify(t,r,n){const o=Buffer.from(e.createHmac("sha256",this.secret).update(t).digest("hex")),i=Buffer.from(r);if(o.length!==i.length)throw new Error("Invalid webhook signature");if(!e.timingSafeEqual(o,i))throw new Error("Invalid webhook signature");if(n){if(Math.abs((new Date).getTime()-n)>6e4)throw new Error("Invalid webhook timestamp")}return!0}parseData(e,t,r){if(!this.verify(e,t,r))throw new Error("Invalid webhook signature");return JSON.parse(e.toString())}}export{o as LINEAR_WEBHOOK_SIGNATURE_HEADER,i as LINEAR_WEBHOOK_TS_FIELD,a as LinearWebhookClient};
//# sourceMappingURL=index-es.min.js.map
